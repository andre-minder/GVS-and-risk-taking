---
title: "A: Counterbalancing"
author: "André Minder"
date: "2023-12-03"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
```

# Information about this script

This script assigns participants to the three conditions of the experiment (L-GVS, R-GVS and SHAM) in order to balance the repeated measures design (see DeMaio et al. (2021) for details). Note that the original study did not clearly state how exactly the condition order was randomized/counterbalanced. For this replication study, we decided to use partial counterbalancing.

The counterbalancing of the conditions was done *separately* for the both behavioral experiments (i.e. BART and GDT). Also, the .csv file generated by this script is needed for the later processing and analyses steps/scripts (see *B2_processing* and *C_Analyses*). More specifically, this table will be used for connecting the three sessions of each experiments with the received stimulation. 

Importantly, participants might get excluded from the analysis if they fall under the specified exclusion criteria (see *B2_processing*). Note that because data is gathered until none of the participants has to be excluded (target sample size = 37), this script generates a table for 120 participants. In the case of exclusion, the new participant is ascribed to a subject number that has the same stimulation block order in the BART as the excluded participant. This guarantees an ongoing counterbalancing.


# Dependencies/Packages

```{r dependencies}

# load the packages: designr to create the factorial design and tidyverse for tidying/wrangling the data
library(designr)
library(tidyverse)
library(kableExtra) # just for printing a nice table in the HTML file

```


# Create the conditions table

In this section, condition tables are created for both behavioral experiments. The tables are created with the package designr (Rabe et al., 2023). The three conditions (i.e. SHAM, L-GVS, and R-GVS) are partially counterbalanced for both experiments. Lastly, both tables are merged into one.

```{r create table}

# Set seed and constants
set.seed(13)
n = 120 # number of participants

# Create a partial counterbalanced design with the stimulus condition
design_BART <- 
  fixed.factor("stimulation",  levels = c("SHAM", "L-GVS", "R-GVS"),
               blocked = TRUE, assign = "permutations") +
  random.factor("subject", groups = "stimulation")

design_GDT <- 
  fixed.factor("stimulation",  levels = c("L-GVS", "SHAM", "R-GVS"),
               blocked = TRUE, assign = "permutations") +
  random.factor("subject", groups = "stimulation", assign = "permutations")

# Extract the codes (i.e. block orders)
conditions_table_BART <- design.codes(design_BART) 
conditions_table_GDT <- design.codes(design_GDT)

# Data wrangling BART: choose relevant variables, rename variables, repeat the permutation blocks, adapt subject values
conditions_table_BART_clean <- conditions_table_BART |> 
  select(-"stimulation") |> 
  rename(BART_session_1 = stimulation.1,
         BART_session_2 = stimulation.2,
         BART_session_3 = stimulation.3) |>
  slice(rep(1:n(), times = 20)) |>
  slice(1:n) |> 
  mutate(subject = formatC(1:n, width = 2, format = "d", flag = "0"), 
         .before = BART_session_1)

# Data wrangling ¨GDT: choose relevant variables, rename variables, repeat the permutation blocks (with reassigning the condition blocks to other participants to avoid order effects), adapt subject values
conditions_table_GDT_clean <- conditions_table_GDT |> 
  select(-"stimulation") |> 
  rename(GDT_session_1 = stimulation.1,
         GDT_session_2 = stimulation.2,
         GDT_session_3 = stimulation.3) |>
  slice(rep(n():1, each = 2)) |>
  slice(rep(1:n(), times = 10)) |> 
  slice(1:n) |> 
  mutate(subject = formatC(1:n, width = 2, format = "d", flag = "0"), 
         .before = GDT_session_1)

# merge the two tables
conditions_table_all <- full_join(
  conditions_table_BART_clean, conditions_table_GDT_clean, by = "subject") 

conditions_table_all |> 
  kable() |>
  add_header_above(header = c("Condition table" = 7)) |>
  kable_classic(full_width = FALSE)
  
```

# Save the data

At the end, the created data frame is saved as a .csv file. A new folder is created for the file, if it does not exist yet.

```{r save}

# in case this dir doesn't exist, create it
dir.create("conditions/")

# save data to disk in that dir
write_csv(conditions_table_all, "conditions/conditions_table.csv")

```

# Session info

```{r}

sessionInfo()

```